name: JMeter Load Test (Multi-Runner)

# Trigger manually
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application Name'
        required: true
        default: 'my-app'
      jmx_file:
        description: 'JMeter test file (.jmx)'
        required: true
      test_type:
        description: 'Type of test: load or smoke'
        required: true
        default: 'load'
      environment:
        description: 'Environment name (dev, qa, prod)'
        required: true
        default: 'dev'
      runners_to_use:
        description: 'Number of parallel runners to use'
        required: true
        default: '1'
      test_name:
        description: 'Optional custom test name'
        required: false
      monitor_system:
        description: 'Enable system monitoring'
        required: false
        default: 'false'

# Static environment variables
env:
  JMETER_VERSION: '5.6.2'
  REPORT_DIR: './reports'
  SCRIPTS_DIR: './scripts'

jobs:
  # Step to determine the final test name
  set-test-name:
    runs-on: ubuntu-latest
    outputs:
      final_test_name: ${{ steps.set-name.outputs.final_test_name }}
    steps:
      - name: Set final test name
        id: set-name
        run: |
          if [ -z "${{ github.event.inputs.test_name }}" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            echo "final_test_name=jmeter-test-$TIMESTAMP" >> $GITHUB_OUTPUT
          else
            echo "final_test_name=${{ github.event.inputs.test_name }}" >> $GITHUB_OUTPUT

  # Run JMeter test with multiple runners
  run-jmeter:
    needs: set-test-name
    if: ${{ github.event.inputs.test_type == 'load' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        runner_index: [1,2,3,4,5] # maximum 5 runners
    steps:
      - name: Skip unused runners
        if: ${{ matrix.runner_index > fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          echo "Runner ${{ matrix.runner_index }} is not used, exiting."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v3

      # Load environment variables from .env if present
      - name: Load .env variables
        if: exists('.env')
        run: |
          export $(grep -v '^#' .env | xargs)

      # Set JMETER_HOME dynamically
      - name: Set JMETER_HOME
        run: |
          echo "JMETER_HOME=${RUNNER_TEMP}/apache-jmeter-${JMETER_VERSION}" >> $GITHUB_ENV

      # Install JMeter
      - name: Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz
          tar -xzf apache-jmeter-${JMETER_VERSION}.tgz -C $RUNNER_TEMP

      # Install JMeter plugins
      - name: Install JMeter Plugins
        run: |
          wget https://jmeter-plugins.org/get/
          sh $JMETER_HOME/bin/PluginsManagerCMD.sh install "jpgc-cmdrunner,jpgc-ultimatethreadgroup,jpgc-mergeresults"

      # Optional system monitoring
      - name: Start system monitoring (optional)
        if: ${{ github.event.inputs.monitor_system == 'true' }}
        run: |
          top -b -d 5 > /tmp/top.log &
          echo $! > /tmp/monitor_pid.txt

      # Run JMeter test
      - name: Run JMeter Test
        run: |
          mkdir -p $REPORT_DIR
          $JMETER_HOME/bin/jmeter -n \
            -t ${{ github.event.inputs.jmx_file }} \
            -l $REPORT_DIR/runner${{ matrix.runner_index }}.jtl \
            -Jenv=${{ github.event.inputs.environment }} \
            -JtestName=${{ needs.set-test-name.outputs.final_test_name }}

      # Stop system monitoring
      - name: Stop system monitoring
        if: ${{ github.event.inputs.monitor_system == 'true' }}
        run: |
          kill $(cat /tmp/monitor_pid.txt) || true

      # Upload JTL artifact
      - name: Upload JTL artifact
        uses: actions/upload-artifact@v3
        with:
          name: runner${{ matrix.runner_index }}-jtl
          path: $REPORT_DIR/runner${{ matrix.runner_index }}.jtl

  # Aggregate results if more than 1 runner
  aggregate-results:
    needs: run-jmeter
    if: ${{ fromJSON(github.event.inputs.runners_to_use) > 1 }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Download all runner JTL files
      - name: Download runner artifacts
        uses: actions/download-artifact@v3
        with:
          name: '**-jtl'
          path: ./artifacts

      # Merge JTL files using simple file concatenation
      - name: Merge JTL files
        run: |
          MERGED_JTL=./artifacts/merged.jtl
          JTL_FILES=$(find ./artifacts -name '*.jtl' | sort)
          # Concatenate files, skipping headers after the first file
          first=1
          > $MERGED_JTL
          for f in $JTL_FILES; do
            if [ $first -eq 1 ]; then
              cat "$f" >> $MERGED_JTL
              first=0
            else
              tail -n +2 "$f" >> $MERGED_JTL
            fi
          done

      # Generate HTML report
      - name: Generate HTML Report
        run: |
          mkdir -p $REPORT_DIR/html
          $JMETER_HOME/bin/jmeter -g ./artifacts/merged.jtl -o $REPORT_DIR/html

      # Upload HTML report
      - name: Upload HTML Report
        uses: actions/upload-artifact@v3
        with:
          name: jmeter-html-report
          path: $REPORT_DIR/html
