name: "JMeter Load Test (Multi-Runner)"

run-name: >
  JMeter Workflow: ${{ github.event.inputs.test_name }}

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Application name (e.g., app1, app2)"
        required: true
      jmx_file:
        description: "Which JMeter test plan to run?"
        required: false
        default: "sample_jmeter.jmx"
        type: choice
        options:
          - sample_jmeter.jmx
          - High_TPS_Runner.jmx
      test_type:
        description: "Choose test type (load/cleanup)"
        required: true
        type: choice
        options:
          - load
          - cleanup
      runners_to_use:
        description: "Number of parallel runners to use (1â€“4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      test_name:
        description: "Optional test name; if blank, YYYYMMDDHHMM will be used"
        required: false
        default: ""
      monitor_system:
        description: "Monitor runner CPU/memory usage during test? true/false"
        required: false
        type: choice
        options:
          - "true"
          - "false"
        default: "false"
      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"
      print_machine_info:
        description: "Set true to print machine details"
        required: false
        type: choice
        options:
          - "true"
          - "false"

env:
  JMETER_VERSION: "5.6.3"
  SCRIPTS_DIR: "applications"
  REPORT_DIR: "./reports"
  JMETER_HOME: "${HOME}/jmeter"

jobs:
  # =========================================================
  # Job 1: Determine final test name
  # =========================================================
  set-test-name:
    runs-on: ubuntu-latest
    outputs:
      final_test_name: ${{ steps.determine.outputs.final_test_name }}

    steps:
      - id: determine
        run: |
          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            NAME="${{ github.event.inputs.test_name }}"
          else
            NAME=$(date +%Y%m%d%H%M)
          fi
          SAFE_NAME=$(echo "$NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')
          echo "final_test_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Test name set to: $SAFE_NAME"

  # =========================================================
  # Job 2: Run JMeter runners in parallel
  # =========================================================
  run-jmeter:
    needs: set-test-name
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner_index: [1,2,3,4]

    steps:
      - uses: actions/checkout@v4

      - name: Skip unused runners
        if: ${{ matrix.runner_index > fromJSON(github.event.inputs.runners_to_use) }}
        run: exit 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl unzip jq openjdk-11-jre-headless

      - name: Install JMeter + PluginsManager + CMDRunner + MergeResults
        run: |
          set -e
          export JMETER_HOME="${HOME}/jmeter"
          mkdir -p "${JMETER_HOME}"

          # Install Apache JMeter
          curl -sL "https://downloads.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" -o jmeter.tgz
          tar -xzf jmeter.tgz -C "${JMETER_HOME}" --strip-components=1
          echo "âœ… Installed Apache JMeter ${JMETER_VERSION}"

          # Install Plugins Manager and CMDRunner
          mkdir -p "${JMETER_HOME}/lib/ext"
          curl -sL https://jmeter-plugins.org/get/ -o "${JMETER_HOME}/lib/ext/jmeter-plugins-manager.jar"
          curl -sL https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.2.1/cmdrunner-2.2.1.jar -o "${JMETER_HOME}/lib/cmdrunner-2.2.1.jar"
          ln -sf "${JMETER_HOME}/lib/cmdrunner-2.2.1.jar" "${JMETER_HOME}/lib/cmdrunner-2.3.jar"

          java -cp "${JMETER_HOME}/lib/ext/jmeter-plugins-manager.jar" org.jmeterplugins.repository.PluginManagerCMDInstaller || true
          chmod +x "${JMETER_HOME}/bin/PluginsManagerCMD.sh" || true
          "${JMETER_HOME}/bin/PluginsManagerCMD.sh" install jpgc-mergeresults
          echo "âœ… MergeResults plugin installed successfully"

      - name: Run JMeter test
        run: |
          TEST_NAME="${{ needs.set-test-name.outputs.final_test_name }}"
          APP_NAME="${{ github.event.inputs.app_name }}"
          TEST_PLAN="${{ env.SCRIPTS_DIR }}/${APP_NAME}/scripts/${{ github.event.inputs.jmx_file }}"
          RESULT_DIR="${{ env.REPORT_DIR }}/${TEST_NAME}-runner-${{ matrix.runner_index }}"
          mkdir -p "$RESULT_DIR"

          "${JMETER_HOME}/bin/jmeter" -n \
            -t "$TEST_PLAN" \
            -l "$RESULT_DIR/results-runner-${{ matrix.runner_index }}.jtl" \
            -e -o "$RESULT_DIR/html-report" \
            -j "$RESULT_DIR/jmeter-runner-${{ matrix.runner_index }}.log"

      - name: Upload runner artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-runner-${{ matrix.runner_index }}
          path: ${{ env.REPORT_DIR }}/${{ needs.set-test-name.outputs.final_test_name }}-runner-${{ matrix.runner_index }}

  # =========================================================
  # Job 3: Merge JTLs
  # =========================================================
  merge-jtl:
    runs-on: ubuntu-latest
    needs: run-jmeter
    env:
      JMETER_VERSION: "5.6.3"

    steps:
      - uses: actions/checkout@v4

      - name: Download all JTL artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/jtls

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl unzip jq openjdk-11-jre-headless

      - name: Install JMeter + PluginsManager + CMDRunner + MergeResults
        run: |
          set -e
          export JMETER_HOME="${HOME}/jmeter"
          mkdir -p "${JMETER_HOME}"

          # Install Apache JMeter
          curl -sL "https://downloads.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" -o jmeter.tgz
          tar -xzf jmeter.tgz -C "${JMETER_HOME}" --strip-components=1
          echo "âœ… Installed Apache JMeter ${JMETER_VERSION}"

          # Install Plugins Manager and CMDRunner
          mkdir -p "${JMETER_HOME}/lib/ext"
          curl -sL https://jmeter-plugins.org/get/ -o "${JMETER_HOME}/lib/ext/jmeter-plugins-manager.jar"
          curl -sL https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.2.1/cmdrunner-2.2.1.jar -o "${JMETER_HOME}/lib/cmdrunner-2.2.1.jar"
          ln -sf "${JMETER_HOME}/lib/cmdrunner-2.2.1.jar" "${JMETER_HOME}/lib/cmdrunner-2.3.jar"

          java -cp "${JMETER_HOME}/lib/ext/jmeter-plugins-manager.jar" org.jmeterplugins.repository.PluginManagerCMDInstaller || true
          chmod +x "${JMETER_HOME}/bin/PluginsManagerCMD.sh" || true
          "${JMETER_HOME}/bin/PluginsManagerCMD.sh" install jpgc-mergeresults
          echo "âœ… MergeResults plugin installed successfully"

      - name: Generate dynamic merge-results.properties
        run: |
          PROPERTIES_FILE=merge-results.properties
          echo "" > $PROPERTIES_FILE
          i=1
          for jtl_file in $(find artifacts/jtls -type f -name "*.jtl"); do
            echo "inputJtl$i=$jtl_file" >> $PROPERTIES_FILE
            echo "prefixLabel$i=RUNNER$i:" >> $PROPERTIES_FILE
            echo "includeLabels$i=.*" >> $PROPERTIES_FILE
            echo "excludeLabels$i=" >> $PROPERTIES_FILE
            echo "includeLabelRegex$i=true" >> $PROPERTIES_FILE
            echo "excludeLabelRegex$i=" >> $PROPERTIES_FILE
            echo "" >> $PROPERTIES_FILE
            i=$((i+1))
          done
          echo "âœ… Generated merge-results.properties"
          cat $PROPERTIES_FILE

      - name: Merge JTL results using MergeResults plugin
        run: |
          cd "${JMETER_HOME}/bin"
          java -cp "../lib/ext/*:../lib/*" \
            org.jmeterplugins.cmd.CmdTool \
            --tool Reporter \
            --input-jtl "$GITHUB_WORKSPACE/merge-results.properties" \
            --plugin-type MergeResults \
            --generate-jtl "$GITHUB_WORKSPACE/merged.jtl"
          echo "âœ… Merged JTL generated successfully"

      - name: Upload merged JTL
        uses: actions/upload-artifact@v4
        with:
          name: merged-jtl
          path: merged.jtl

  # =========================================================
  # Job 4: Cleanup
  # =========================================================
  cleanup-artifacts:
    if: ${{ github.event.inputs.test_type == 'cleanup' }}
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old runner results
        run: |
          echo "ðŸ§¹ Cleaning runner results older than ${{ github.event.inputs.cleanup_days }} days..."
          find ${{ env.REPORT_DIR }} -maxdepth 1 -type d -name "*-runner-*" -mtime +${{ github.event.inputs.cleanup_days }} -exec rm -rf {} +
          echo "âœ… Old runner directories deleted."
