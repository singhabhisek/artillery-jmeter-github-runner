name: "JMeter Load Test (Multi-Runner)"

run-name: >
  JMeter Workflow: ${{ github.event.inputs.test_name }}

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Application name (e.g., App1, App2)"
        required: true
      jmx_file:
        description: "Which JMeter test plan to run?"
        required: false
        default: "sample_jmeter.jmx"
        type: choice
        options:
          - sample_jmeter.jmx
          - High_TPS_Runner.jmx
      test_type:
        description: "Choose test type (e.g., load/cleanup)"
        required: true
        type: choice
        options:
          - load
          - cleanup
      runners_to_use:
        description: "Number of parallel runners to use (1â€“4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      test_name:
        description: "Optional test name; if blank, YYYYMMDDHHMM will be used"
        required: false
        default: ""
      monitor_system:
        description: "Monitor runner CPU/memory usage during test? true/false"
        required: false
        type: choice
        options:
          - "true"
          - "false"
        default: "false"
      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"
      print_machine_info:
        description: "Set true to print machine details"
        required: false
        type: choice
        options:
          - "true"
          - "false"

env:
  JMETER_VERSION: "5.6.3"            # JMeter version to install
  SCRIPTS_DIR: "./scripts"           # Directory containing JMeter scripts
  REPORT_DIR: "./jmeter-results"     # Base directory for runner results
  JMETER_HOME: "$HOME/jmeter"        # JMeter installation directory

# =========================================================
# Job 1: Determine final test name
# =========================================================
jobs:
  set-test-name:
    runs-on: ubuntu-latest
    outputs:
      final_test_name: ${{ steps.determine.outputs.final_test_name }}

    steps:
      - id: determine
        run: |
          # If user provides test_name, use it; else fallback to timestamp
          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            NAME="${{ github.event.inputs.test_name }}"
          else
            NAME=$(date +%Y%m%d%H%M)
          fi

          # Sanitize: replace non-alphanumeric characters with underscores
          SAFE_NAME=$(echo "$NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')

          # Export for downstream jobs
          echo "final_test_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Test name set to: $SAFE_NAME"

# =========================================================
# Job 2: Run JMeter (multi-runner)
# =========================================================
  run-jmeter:
    needs: set-test-name
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        runner_index: [1,2,3,4]

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # Skip unused runners
      # -------------------------------
      - name: Skip unused runner jobs
        if: ${{ matrix.runner_index > fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          echo "Skipping runner ${{ matrix.runner_index }}"
          exit 0

      # -------------------------------
      # Print machine info if requested
      # -------------------------------
      - name: Print machine details
        if: ${{ github.event.inputs.print_machine_info == 'true' }}
        run: |
          echo "===== Machine Info ====="
          echo "CPU cores: $(nproc)"
          echo "Memory: $(free -h)"
          echo "Public IP: $(curl -s ifconfig.me)"
          curl -s https://ipapi.co/json/
          echo "========================"

      # -------------------------------
      # Load app-specific environment variables (.env)
      # -------------------------------
      - name: Load environment variables
        shell: bash
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          echo "â„¹ï¸ Running test for app: $APP_NAME"

          # Path to app-specific .env file
          ENV_FILE="./${APP_NAME}/.env"

          if [ -f "$ENV_FILE" ]; then
            echo "âœ… Loading environment variables from $ENV_FILE"
            # Export all non-comment, non-empty lines
            set -o allexport
            grep -v '^#' "$ENV_FILE" | grep -v '^\s*$' | while read -r line; do
              if [[ "$line" == *"="* ]]; then
                varname=$(echo "$line" | cut -d '=' -f 1)
                value=$(echo "$line" | cut -d '=' -f 2-)
                export "$varname=$value"
                echo "   Loaded $varname"
              fi
            done
            set +o allexport
          else
            echo "âš ï¸ .env file not found for $APP_NAME, using defaults or empty values"
            export DURATION="${DURATION:-}"
            export THREADS="${THREADS:-}"
            export RAMPUP="${RAMPUP:-}"
            export AUTH_HEADER="${AUTH_HEADER:-}"
            export API_KEY="${API_KEY:-}"
            export AWS_ACCESS_KEY="${AWS_ACCESS_KEY:-}"
            export AWS_SECRET_KEY="${AWS_SECRET_KEY:-}"
          fi

          # Export for GitHub Actions downstream steps
          echo "DURATION=$DURATION" >> $GITHUB_ENV
          echo "THREADS=$THREADS" >> $GITHUB_ENV
          echo "RAMPUP=$RAMPUP" >> $GITHUB_ENV
          echo "AUTH_HEADER=$AUTH_HEADER" >> $GITHUB_ENV
          echo "API_KEY=$API_KEY" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY=$AWS_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_SECRET_KEY=$AWS_SECRET_KEY" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "${{ github.event.inputs.jmx_name }}"

      # -------------------------------
      # Check JMeter test plan exists
      # -------------------------------
      - name: Check JMeter test plan exists
        run: |
          TEST_PLAN="${{ env.SCRIPTS_DIR }}/$APP_NAME/${{ github.event.inputs.jmx_name }}"
          if [ ! -f "$TEST_PLAN" ]; then
            echo "âŒ Test plan $TEST_PLAN not found!"
            exit 1
          fi
          echo "âœ… Test plan found: $TEST_PLAN"

      # -------------------------------
      # Install JMeter
      # -------------------------------
      - name: Install JMeter
        run: |
          JMETER_VERSION=${{ env.JMETER_VERSION }}
          mkdir -p $HOME/jmeter
          curl -L https://downloads.apache.org/jmeter/binaries/apache-jmeter-$JMETER_VERSION.tgz -o jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-$JMETER_VERSION $HOME/jmeter
          echo "$HOME/jmeter/bin" >> $GITHUB_PATH
          echo "âœ… JMeter installed"

      # -------------------------------
      # Install required plugins
      # -------------------------------
      - name: Install JMeter Plugins
        run: |
          mkdir -p $HOME/jmeter/lib/ext
          # Dummy plugin
          curl -L -o /tmp/jpgc-dummy-0.4.zip https://jmeter-plugins.org/files/packages/jpgc-dummy-0.4.zip
          unzip -o /tmp/jpgc-dummy-0.4.zip -d /tmp/dummy-plugin
          find /tmp/dummy-plugin -name "*.jar" -exec cp {} $HOME/jmeter/lib/ext/ \;

          # Ultimate Thread Group
          curl -L -o /tmp/jpgc-ultimate-thread-group-3.0.zip https://jmeter-plugins.org/files/packages/jpgc-casutg-3.1.1.zip
          unzip -o /tmp/jpgc-ultimate-thread-group-3.0.zip -d /tmp/ultimate-plugin
          find /tmp/ultimate-plugin -name "*.jar" -exec cp {} $HOME/jmeter/lib/ext/ \;

          # CMDRunner
          curl -L -o /tmp/cmdrunner-2.3.jar https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar
          cp /tmp/cmdrunner-2.3.jar $HOME/jmeter/lib/

      # -------------------------------
      # Optional system monitoring
      # -------------------------------
      - name: Start system monitoring (optional)
        if: ${{ github.event.inputs.monitor_system == 'true' }}
        run: |
          mkdir -p "${{ env.REPORT_DIR }}"
          LOG_FILE="${{ env.REPORT_DIR }}/runner-${{ matrix.runner_index }}-system.log"
          echo "timestamp,cpu_user,cpu_system,cpu_idle,mem_used,mem_free" > $LOG_FILE
          monitor() {
            while true; do
              ts=$(date +"%Y-%m-%d %H:%M:%S")
              cpu=$(mpstat 1 1 | awk '/Average/ {print $3","$5","$12}')
              mem=$(free -m | awk '/Mem:/ {print $3","$4}')
              echo "$ts,$cpu,$mem" >> $LOG_FILE
              sleep 180
            done
          }
          monitor &
          echo $! > /tmp/monitor_pid.txt

      # -------------------------------
      # Run JMeter Test
      # -------------------------------
      - name: Run JMeter Test
        id: run_test
        run: |
          TEST_NAME="${{ needs.set-test-name.outputs.final_test_name }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULT_DIR="${{ env.REPORT_DIR }}/${TEST_NAME}-runner-${{ matrix.runner_index }}-$TIMESTAMP"
          mkdir -p "$RESULT_DIR"

          # Run JMeter in non-GUI mode, passing all variables
          jmeter -n \
            -t "${{ env.SCRIPTS_DIR }}/$APP_NAME/${{ github.event.inputs.jmx_name }}" \
            -l "$RESULT_DIR/results.jtl" \
            -e -o "$RESULT_DIR/html-report" \
            -j "$RESULT_DIR/jmeter.log" \
            -Jjmeter.save.saveservice.autoflush=true \
            -JDURATION="$DURATION" \
            -JTHREADS="$THREADS" \
            -JRAMPUP="$RAMPUP" \
            -JAUTH_HEADER="$AUTH_HEADER" \
            -JAPI_KEY="$API_KEY" \
            -JAWS_ACCESS_KEY="$AWS_ACCESS_KEY" \
            -JAWS_SECRET_KEY="$AWS_SECRET_KEY" \
            -JAPP_NAME="$APP_NAME"

          echo "result_dir=$RESULT_DIR" >> $GITHUB_OUTPUT

      # -------------------------------
      # Stop system monitoring
      # -------------------------------
      - name: Stop system monitoring
        if: ${{ github.event.inputs.monitor_system == 'true' }}
        run: |
          if [ -f /tmp/monitor_pid.txt ]; then
            kill $(cat /tmp/monitor_pid.txt) || true
            rm /tmp/monitor_pid.txt
          fi

      # -------------------------------
      # Package runner artifacts
      # -------------------------------
      - name: Package Runner Artifacts
        run: |
          ZIP_NAME="runner-${{ matrix.runner_index }}-results.zip"
          mkdir -p upload
          zip -r "upload/$ZIP_NAME" "${{ steps.run_test.outputs.result_dir }}"
          echo "Packaged runner ZIP: upload/$ZIP_NAME"

      - name: Upload Runner Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-runner-${{ matrix.runner_index }}
          path: upload/*.zip

# =========================================================
# Job 3: Aggregate reports using MergeResults plugin
# =========================================================
  aggregate-reports:
    needs: run-jmeter
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_type == 'load' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl unzip jq

      - name: Install JMeter & Plugins
        run: |
          JMETER_HOME="$HOME/jmeter"
          mkdir -p $JMETER_HOME
          curl -sL "https://downloads.apache.org/jmeter/binaries/apache-jmeter-${{ env.JMETER_VERSION }}.tgz" -o jmeter.tgz
          tar -xzf jmeter.tgz -C $JMETER_HOME --strip-components=1
          mkdir -p $JMETER_HOME/lib/ext
          # Install PluginsManager + CMDRunner + MergeResults
          curl -sL https://jmeter-plugins.org/get/ -o $JMETER_HOME/lib/ext/jmeter-plugins-manager.jar
          curl -sL https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.2.1/cmdrunner-2.2.1.jar -o $JMETER_HOME/lib/cmdrunner-2.2.1.jar
          java -cp $JMETER_HOME/lib/ext/jmeter-plugins-manager.jar org.jmeterplugins.repository.PluginManagerCMDInstaller || true
          chmod +x $JMETER_HOME/bin/PluginsManagerCMD.sh || true
          $JMETER_HOME/bin/PluginsManagerCMD.sh install jpgc-mergeresults

      - name: Download runner artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged-artifacts

      - name: Merge multiple JTLs
        shell: bash
        run: |
          set -e
          mkdir -p final-results
          mapfile -t JTLS < <(find merged-artifacts -type f -name "*.jtl")
          if [ ${#JTLS[@]} -eq 0 ]; then
            echo "âŒ No JTL files found to merge."
            exit 1
          fi
          echo "â„¹ï¸ Merging ${#JTLS[@]} JTL files using MergeResults plugin..."
          CMD_JAR="$HOME/jmeter/lib/cmdrunner-2.2.1.jar"
          MERGED_JTL="final-results/merged.jtl"
          JAVA_CMD="java -jar \"$CMD_JAR\" --tool Reporter --plugin-type MergeResults"
          for f in "${JTLS[@]}"; do
            JAVA_CMD="$JAVA_CMD --input-jtl \"$f\""
          done
          JAVA_CMD="$JAVA_CMD --generate-csv \"$MERGED_JTL\""
          eval "$JAVA_CMD"
          echo "âœ… Merged JTL created: $MERGED_JTL"

      - name: Generate HTML Dashboard
        shell: bash
        run: |
          MERGED_JTL="final-results/merged.jtl"
          REPORT_DIR="final-results/html-report"
          mkdir -p "$REPORT_DIR"
          $HOME/jmeter/bin/jmeter -g "$MERGED_JTL" -o "$REPORT_DIR"
          echo "âœ… HTML report generated at $REPORT_DIR"

      - name: Package consolidated artifacts
        run: |
          mkdir -p final-upload
          cp merged-artifacts/**/*.zip final-upload/ || true
          cp -r final-results final-upload/final-results || true
          zip -r "consolidated-results.zip" final-upload/

      - uses: actions/upload-artifact@v4
        with:
          name: consolidated-jmeter-results
          path: consolidated-results.zip

# =========================================================
# Job 4: Cleanup old artifacts
# =========================================================
  cleanup-artifacts:
    if: ${{ github.event.inputs.test_type == 'cleanup' }}
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old runner results
        run: |
          echo "ðŸ§¹ Cleaning runner results older than ${{ github.event.inputs.cleanup_days }} days..."
          find ${{ env.REPORT_DIR }} -maxdepth 1 -type d -name "*-runner-*" -mtime +${{ github.event.inputs.cleanup_days }} -exec rm -rf {} +
          echo "âœ… Old runner directories deleted."

      - name: Cleanup old consolidated results
        run: |
          echo "ðŸ§¹ Cleaning consolidated directories older than ${{ github.event.inputs.cleanup_days }} days..."
          find consolidated -maxdepth 1 -type d -mtime +${{ github.event.inputs.cleanup_days }} -exec rm -rf {} + || true
          echo "âœ… Old consolidated directories deleted."
